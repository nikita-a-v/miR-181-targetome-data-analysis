---
title: "RNAhybrid_heatmaps_fig2"
author: "Nikita Verheyden"
date: "2023-04-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

directory
```{r}
setwd("D:/Krueger_Lab/Publications/miR181_paper/Figure2/RNAhybrid")
```


## packages
```{r packages}
source("D:/Krueger_Lab/Publications/miR181_paper_v21022023/Figure_theme/theme_paper.R")
library(BSgenome.Mmusculus.UCSC.mm10)
library(dplyr)
library(ggplot2)
library(seqinr)
library(circlize)
library(ComplexHeatmap)
```

## Data

the files imported here are created with RNAhybid with the "RNAhybrid fig 2" script

```{r data}
Personalized_Reader <- function(lambda){
 read.table(lambda, sep = ":") %>% select(V1, V5, V6, V7, V10, V11)}

#File lists
reslistA <- list.files(path = "D:/Krueger_Lab/Publications/miR181_paper_nongithub/Figure2/RNAhybrid/results_mir181a_u3", full.names=TRUE)
reslistB <- list.files(path = "D:/Krueger_Lab/Publications/miR181_paper_nongithub/Figure2/RNAhybrid/results_mir181b_u3", full.names=TRUE)


#import
myfilelistA <- lapply(reslistA, Personalized_Reader)
myfilelistB <- lapply(reslistB, Personalized_Reader) 




resframeA <- bind_rows(myfilelistA)
resframeB <- bind_rows(myfilelistB)



#colnames
colnames(resframeA) <- c("rownumber", "mfs", "pvalue", "start_position", "binding_bases", "non_binding_bases")
colnames(resframeB) <- c("rownumber", "mfs", "pvalue", "start_position", "binding_bases", "non_binding_bases")

resframeA[is.na(resframeA$non_binding_bases),"non_binding_bases"] <- "                       "
resframeB[is.na(resframeB$non_binding_bases),"non_binding_bases"] <- "                       "



head(resframeA)
head(resframeB)





```
## colours
```{r colours}
#colours
farbeneg <- "#b4b4b4"
farbe1 <- "#0073C2FF"
farbe2 <- "#EFC000FF"
farbe3 <- "#CD534CFF"
farbe4 <- "#7AA6DCFF"
farbe5 <- "#868686FF"
farbe6 <- "#003C67FF"
farbe7 <- "#8F7700FF"
farbe8 <- "#3B3B3BFF"
farbe9 <- "#A73030FF"
farbe10 <- "#4A6990FF"
farbe11 <- "#FF6F00FF"
farbe12 <- "#C71000FF"
farbe13 <- "#008EA0FF"
farbe14 <- "#8A4198FF"
farbe15 <- "#5A9599FF"
farbe16 <- "#FF6348FF"
  
RNApcol <- "#b56504"
RNAncol <- "#027d73"
RPFpcol <- "#c4c404"
RPFncol <- "#8d0391"
```





## Process data (remove gaps)

Due to the loops in the mRNA there are additional spaces in the mirna. We only want the binding and non binding bases of hte mirna in te correct order.
For that we will remove all gaps that origin in the mRNA loops.
```{r remove_loop}
#binding and non binding bases as characters in a list
Alistbb <- strsplit(resframeA$binding_bases,"")
Alistnb <- strsplit(resframeA$non_binding_bases,"")

Blistbb <- strsplit(resframeB$binding_bases,"")
Blistnb <- strsplit(resframeB$non_binding_bases,"")



#combine the two lists
Alist <- Map(cbind, Alistbb, Alistnb)
Alist <- lapply(Alist, as.data.frame)

Blist <- Map(cbind, Blistbb, Blistnb)
Blist <- lapply(Blist, as.data.frame)




#remove all empty rows (mRNA loops)
Alist0 <- lapply(Alist, function(x){
  x[!(x[,1]== " " & x[,2] == " "),]
})

Blist0 <- lapply(Blist, function(x){
  x[!(x[,1]== " " & x[,2] == " "),]
})




#rewrite as characters
AlistF <- lapply(Alist0, function(x){
  paste(x[,1],  collapse = '')
})

BlistF <- lapply(Blist0, function(x){
  paste(x[,1],  collapse = '')
})








#Attach lists back onto original data.frame as new column
resframeA$binding_nospace <-unlist(AlistF)
head(resframeA$binding_nospace)

resframeB$binding_nospace <-unlist(BlistF)
head(resframeB$binding_nospace)


```

# Transform into Numbers

## add 0s

replace all gaps with 0 and all letters with 1
```{r nummerify}
#0
resframeA$binding_nospace <- chartr(" ", "0", resframeA$binding_nospace)
resframeB$binding_nospace <- chartr(" ", "0", resframeB$binding_nospace)



#1
resframeA$binding_nospace <- mgsub::mgsub(resframeA$binding_nospace, c("A", "U", "C", "G"), c(rep("1", 4)))
resframeB$binding_nospace <- mgsub::mgsub(resframeB$binding_nospace, c("A", "U", "C", "G"), c(rep("1", 4)))


head(resframeA)
head(resframeB)


```

## seperate into columns

for each base make 1 column so it can be added and also put into a heatmap
```{r heatframes}
#for the heatmap with every binding site
heatframeA <- do.call(rbind.data.frame, strsplit(resframeA$binding_nospace,""))
heatframeA <- sapply( heatframeA, as.numeric )
colnames(heatframeA) <- c(23:1)
rownames(heatframeA) <- resframeA[,1]
head(heatframeA)

heatframeB <- do.call(rbind.data.frame, strsplit(resframeB$binding_nospace,""))
heatframeB <- sapply( heatframeB, as.numeric )
colnames(heatframeB) <- c(24:1)
rownames(heatframeB) <- resframeB[,1]
head(heatframeB)



#reverse column order
heatframeA <-heatframeA[,23:1]
heatframeB <- heatframeB[,24:1]
```

## sum of columns

```{r sumframes}
#sum for the small heatmap with the overall binding ratio for each base
framesumA <- colSums(heatframeA)
framesumB <- colSums(heatframeB)



framesum <- as.data.frame(rbind(framesumA,framesumB))
rownames(framesum) <- c("miR181a", "miR181b")
framesum

#scale for better comperativity
sframesum <- as.data.frame(t(scale(t(framesum))))
```

# Heatmap

Colours
```{r hm_colours}
hmcols1 <- c("white", "black")
hmcols2 <- colorRamp2(c(-2, 2), c("white", "red"))

```

## Heatmap of all the single reads

make heatmap without column clustering but with row clustering
```{r allmap,  fig.dim = c(7, 5)}
HMA <- Heatmap(heatframeA, cluster_columns = F, col = hmcols1, row_km = 5, show_row_names = F, show_row_dend = F, border = TRUE)
HMB <- Heatmap(heatframeB, cluster_columns = F, col = hmcols1, row_km = 5, show_row_names = F, show_row_dend = F, border = TRUE)

```
No B
```{r A}
HMA
```
B
```{r B}
HMB
```



## "Heatmap" of combined reads for mir_181a and b

No clustering, only sums
```{r fusemap,  fig.dim = c(5, 2)}
HMF <- Heatmap(sframesum, cluster_columns = F, cluster_rows = F, col = hmcols2)

HMF
```

# session info
```{r session_info}
sessionInfo()
```

