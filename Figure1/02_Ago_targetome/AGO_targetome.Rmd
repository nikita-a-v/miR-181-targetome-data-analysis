---
title: "AGO targetome"
author: "Melina Klostermann"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  # BiocStyle::html_document:
  #   toc_float: TRUE
  #   code_folding: hide
  #   toc: TRUE
  #   number_sections: yes
  #   fig_caption: yes
  pdf_document:
    fig_caption: true
    fig_crop: true
    toc: true
    toc_depth: 1
    number_sections: true
---

```{r setup, include=FALSE}
require("knitr")
knitr::opts_chunk$set(warning=FALSE, message=FALSE, cache=F, cache.lazy = FALSE, crop = NULL)
tidy.opts=list(width.cutoff=80,tidy=TRUE, echo=FALSE)


# nikita source
# source("D:/Krueger_Lab/Publications/miR181_paper_v21022023/Figure_theme/theme_paper.R")



library(ggplot2)
here <- here::here()

source(paste0(here,"/Supporting_scripts/themes/theme_paper.R"))
theme_set(theme_paper())
```

# Libraries and settings


```{r libraries, include=FALSE}
# ----------------------------------------
# libraries
# ----------------------------------------
library(dplyr)
library(purrr)
library(rtracklayer)
library(GenomicRanges)
library(kableExtra)
library(ComplexHeatmap)
library(Biostrings)
library(BSgenome.Mmusculus.UCSC.mm10)
library(circlize)
library(ggpubr)
library(ggrepel) # Nikita


# ----------------------------------------
# settings
# ----------------------------------------

out <- paste0(here,"/Figure1+SF1a-g/03_Ago_targetome/")

#Nikita out
# out <- "D:/Krueger_Lab/Publications/miR181_paper/Figure1/Ago_targetome/"

# farben
farbe1 <- "#0073C2FF" #WT farbe
farbe3 <- "#CD534CFF" #miR181KO farbe

```

# What was done?

- Overview of the detected chimeric reads in all conditions.
- Chimeric reads are assigned to AGO-binding sites (chimeric AGO sites).
- Co-ocurrence of miRs in the same AGO binding site (fisher-test heatmap).

We obtain chimeric reads from 4 different conditions:
- AGO eCLIP (IP_WT)
- AGO eCLIP with mir181a KO and mir181b KO (IP_KO)
- AGO eCLIP with mir181 enrichment (IP_mir181_WT)
- AGO eCLIP with mir181 enrichment and with mir181a KO and mir181b KO (IP_mir181_KO)

# Files
```{r}
# ----------------------------------------
# AGO binding sites
# ----------------------------------------
ago_bs <- readRDS(paste0(here,"/Figure1+SF1a-g/02_AGO_binding_site_definition/AGO_BS.rds"))


# ----------------------------------------
# chimeric reads
# ----------------------------------------
mir_crosslinks <- list.files("/Users/melinaklostermann/Documents/projects/AgoCLIP_miR181/pipe_output_22_02_14/chimeric/crosslinks/",
                             pattern = "*.bed", recursive = TRUE, full.names = T) %>% map(~import.bed(.x, extraCols = c(Name = "character", Score="numeric", Strand="factor")))
names(mir_crosslinks) <- list.files("/Users/melinaklostermann/Documents/projects/AgoCLIP_miR181/pipe_output_22_02_14/chimeric/crosslinks/",
                             pattern = "*.bed")

# Nikita source
# mir_crosslinks <- list.files("D:/Krueger_Lab/miReCLIP/Melina/pipe_output_22_02_14/pipe_output_22_02_14/chimeric/crosslinks/", 
#                              pattern = "*.bed", recursive = TRUE, full.names = T) %>% map(~import.bed(.x, extraCols = c(Name = "character", Score="numeric", Strand="factor")))
# names(mir_crosslinks) <- list.files("D:/Krueger_Lab/miReCLIP/Melina/pipe_output_22_02_14/pipe_output_22_02_14/chimeric/crosslinks/", 
#                              pattern = "*.bed")
# 
# 
# 

# ----------------------------------------
# mir181 expression imgen
# ----------------------------------------
mir_imgen <- read.csv("/Users/melinaklostermann/Documents/projects/AgoCLIP_miR181/files_public_mir_data/DPsets_immgen.csv")

# Nikita source
# mir_imgen <- read.csv("D:/Krueger_Lab/Publications/miR181_paper/Figure1/Ago_targetome/DPsets_immgen.csv")



```

# Chimeric reads
These are the chimeric reads that were isolated during the read processing via raccon (link TODO)

## Number of chimeric reads per sample

```{r}
# ----------------------------------------
# get chimeric reads
# ----------------------------------------

# clean files
mir_crosslinks <- map(mir_crosslinks, ~ as.data.frame(.x) %>%
                        mutate(strand = Strand, Strand = NULL))

sample_names <- c("Inp1_KO1", "Inp2_KO2", "Inp3_KO3", 
                  "Inp4_WT1", "Inp5_WT2", "Inp6_WT3",
                  "IP1_KO1", "IP2_KO2", "IP3_KO3",
                  "IP4_WT1", "IP5_WT2", "IP6_WT3",
                  "IP7_KO1_miR181", "IP8_KO2_miR181", "IP9_KO3_miR181",
                  "IP10_WT1_miR181", "IP11_WT2_miR181", "IP12_WT3_miR181"
                  )

mir_crosslinks <- map( sample_names , ~bind_rows(mir_crosslinks[grepl(names(mir_crosslinks), pattern = .x)] ))

names(mir_crosslinks) <- sample_names

# make overview table

table_num_crosslinks <- map_dfr(mir_crosslinks, ~c(number_of_crosslinks = NROW(.x)))
table_num_crosslinks$sample <- sample_names

kable(table_num_crosslinks[,c(2,1)], format.args = list(big.mark = ",")) %>%
  kable_material(c("striped", "hover")) %>%
  scroll_box(width = "100%", height = "500px")


```

## FigureS1B Barchart chimeric reads per sample

```{r n_chimeric_reads_barchart}
# ----------------------------------------
# Chimeric reads per sample
# Supplementary Figure 1 b
# ----------------------------------------


gg_df <- table_num_crosslinks %>% subset(sample %in% c("IP1_KO1", "IP2_KO2", "IP3_KO3",
                  "IP4_WT1", "IP5_WT2", "IP6_WT3",
                  "IP7_KO1_miR181", "IP8_KO2_miR181", "IP9_KO3_miR181",
                  "IP10_WT1_miR181", "IP11_WT2_miR181", "IP12_WT3_miR181"))

p <- ggplot(gg_df, aes(x = factor(sample, levels = sample), y = number_of_crosslinks))+
  geom_col()+
  coord_flip()+
  ylab("")+
  xlab("Number of crosslinks")

p + ggtitle("Chimeric reads per sample")
```

```{r n_chimeric_reads_barchart_paper}
p <- p + theme_paper()

ggsave(p, filename = paste0(out, "FigureS1B_Barchart_chimeric_reads.pdf"), width = unit(6, "cm"), height = unit(6,"cm"))

```

## Detected mirs per sample

```{r}
detected_mirs <- map(mir_crosslinks, ~.x %>% 
                       group_by(`Name`) %>% 
                       summarise(n = sum(Score), .groups= "keep") )

detected_mirs <- map(detected_mirs, ~arrange(.x, desc(n)))

```


## Detected mirs per condition

```{r merge_per_condition, results='hide'}
condition_regex <- list("Inp.+KO", "Inp.+WT", 
                  "IP.+KO[1-3]+$",  "IP.+WT[1-3]+$", 
                  "IP.+KO.+_miR181", "IP.+_WT.+_miR181" )
condition_names <- list("Inp_KO", "Inp_WT", 
                  "IP_KO",  "IP_WT", 
                  "IP_KO_miR181", "IP_WT_miR181" )


mir_crosslinks_per_cond <- map(condition_regex,
                   ~bind_rows(mir_crosslinks[grepl(names(mir_crosslinks), pattern =.x)] ))

names(mir_crosslinks_per_cond ) <- condition_names

```

```{r results='hide' }
detected_mirs_per_cond <- map(mir_crosslinks_per_cond, ~.x %>% 
                       group_by(`Name`) %>% 
                       summarise(n = sum(Score), .groups= "keep",
                                 mean = n/3) )

detected_mirs_per_cond <- map(detected_mirs_per_cond , ~arrange(.x, desc(n)))

detected_mirs_per_cond_top_10 <- map(detected_mirs_per_cond, ~.x[1:10,] %>%
                              arrange(., n))
                     
```

### AGO-IP
- Number of differnt miRs in AGO-IP: `r nrow(detected_mirs_per_cond$IP_WT)`

- number of chimeric reads in AGO-IP: `r sum(detected_mirs_per_cond$IP_WT$n)`

- percent mir181a in AGO-IP: `r detected_mirs_per_cond$IP_WT %>% subset(Name == "mmu-miR-181a-5p") %>% pull(n) / sum(detected_mirs_per_cond$IP_WT$n)`

- percent mir181a in AGO-IP: `r detected_mirs_per_cond$IP_WT %>% subset(Name == "mmu-miR-142a-3p") %>% pull(n) / sum(detected_mirs_per_cond$IP_WT$n)`

### mir181 AGO IP
- Number of differnt miRs in mir181-AGO-IP: `r nrow(detected_mirs_per_cond$IP_WT_miR181)`

- number of chimeric reads in mir181-AGO-IP: `r sum(detected_mirs_per_cond$IP_WT_miR181$n)`

- percent mir181a in mir181-AGO-IP: `r detected_mirs_per_cond$IP_WT_miR181 %>% subset(Name == "mmu-miR-181a-5p") %>% pull(n) / sum(detected_mirs_per_cond$IP_WT_miR181$n)`

- percent mir181a in mir181-AGO-IP: `r detected_mirs_per_cond$IP_WT_miR181 %>% subset(Name == "mmu-miR-181b-5p") %>% pull(n) / sum(detected_mirs_per_cond$IP_WT_miR181$n)`

## Supplementary Table 1

```{r xlsx_detected_mir}
# ----------------------------------------
# excel tables of detected miRs
# Supplementary Table 1
# ----------------------------------------

xlsx::write.xlsx(x = as.data.frame(detected_mirs_per_cond$IP_WT), file = paste0(out,"detected_miR_IP_WT_", Sys.Date(), ".xlsx")) 
xlsx::write.xlsx(x = as.data.frame(detected_mirs_per_cond$IP_KO), file = paste0(out,"detected_miR_IP_KO_", Sys.Date(), ".xlsx")) 
xlsx::write.xlsx(x = as.data.frame(detected_mirs_per_cond$IP_WT_miR181), file = paste0(out,"detected_miR_IP_WT_miR181_", Sys.Date(), ".xlsx")) 
xlsx::write.xlsx(x = as.data.frame(detected_mirs_per_cond$IP_KO_miR181), file = paste0(out,"detected_miR_IP_KO_miR181_", Sys.Date(), ".xlsx")) 

```

### Barchart IP_WT/KO topb mirs & IP_mir181_WT/KO

```{r}
# ----------------------------------------
# Barcharts of top miRs per condition
# Figure 1 d & Figure 2 a
# ----------------------------------------


# Barchart of AGO IP
#####################

# make one df with all conditions
conditions_of_samples_list <- rep(condition_names, each =3)
mirs <- pmap(list(x=detected_mirs, y=as.list(sample_names), z= conditions_of_samples_list),
                             function(x,y,z) mutate(x, Sample = y, 
                                                    condition = z)) %>%
  map_dfr(~.x)

# get conditions
mirs_ago_wt_ko <- mirs %>% subset(condition %in% c("IP_WT", "IP_KO"))

# calculate relative amount per condition
mirs_ago_wt_ko <- mirs_ago_wt_ko %>% 
  mutate( n_total = case_when(condition == "IP_WT" ~ sum(detected_mirs_per_cond$IP_WT$n),
                              condition == "IP_KO" ~ sum(detected_mirs_per_cond$IP_KO$n))) %>%
  group_by(condition, Name) %>%
  mutate( 
    n_per_cond_rel = sum(n)/n_total,
    sum = sum(n))

# select top 10 from wt condition
mirs_t10_ago_wt_ko <- mirs_ago_wt_ko %>% subset(Name %in% c(detected_mirs_per_cond_top_10$IP_WT$Name, "mmu-miR-181c-5p", "mmu-miR-181d-5p")) %>% 
                                                  arrange(desc(condition), n_per_cond_rel)



p1 <- ggplot(mirs_t10_ago_wt_ko, aes(x = factor(Name, levels = unique(Name)), y = sum, fill = factor(condition, levels = unique(condition))))+
   geom_col( stat="identity",position = "dodge")+
      #scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c(farbe1, farbe3))+
  xlab("") +
  ylab("miR chimeric reads")+
  coord_flip()

p1 + ggtitle("Ago chimeric reads (non normalised)")



# Barchart of 181 IP
#####################

# get conditions
mirs_181_wt_ko <- mirs %>% subset(condition %in% c("IP_WT_miR181", "IP_KO_miR181"))

# calculate relative amount per condition
mirs_181_wt_ko <- mirs_181_wt_ko %>% 
  mutate( n_total = case_when(condition == "IP_WT_miR181" ~ sum(detected_mirs_per_cond$IP_WT_miR181$n),
                              condition == "IP_KO_miR181" ~ sum(detected_mirs_per_cond$IP_KO_miR181$n))) %>%
  group_by(condition, Name) %>%
  mutate( 
    n_per_cond_rel = sum(n)/n_total,
    sum = sum(n))

# select top 10 from wt condition
mirs_t10_181_wt_ko <- mirs_181_wt_ko %>% subset(Name %in% c(detected_mirs_per_cond_top_10$IP_WT$Name, "mmu-miR-181c-5p", "mmu-miR-181d-5p")) %>% 
                                                  arrange(desc(condition), n_per_cond_rel)




p3 <- ggplot(mirs_t10_181_wt_ko, aes(x = factor(Name, levels = unique(mirs_t10_ago_wt_ko$Name)), y = sum, fill = factor(condition, levels = unique(condition))))+
   geom_col( stat="identity",position = "dodge")+
      #scale_x_discrete(guide = guide_axis(angle = 45)) +
  scale_fill_manual(values = c(farbe1, farbe3))+
  xlab("") +
  ylab("miR chimeric reads")+
  coord_flip()

p3 + ggtitle("181 enriched chimeric reads (non-normalised)")




```

```{r barchart_for_paper}
# save for paper
p1 <- p1 + theme_paper()
p3 <- p3 + theme_paper()

ggsave(p1, filename = paste0(out, "Figure1E_Barchart_IP_WT_KO_top_mirs.pdf"), width = unit(6, "cm"), height = unit(6,"cm"))
ggsave(p3, filename = paste0(out, "Figure2A_Barchart_IP_WT_KO_181enriched_top_mirs.pdf"), width = unit(6, "cm"), height = unit(6,"cm"))


```

# Assign chimeric reads to binding sites

We assign chimeric reads that are in a window of 10nt before the binding site until 10nt after the binding site to the respective binding site.

```{r}
# use region of bs +-10nt for overlaps
ago_bs_10 <- ago_bs + 10

# find overlaps of mirt and AGO bs
idx <- findOverlaps(ago_bs_10, 
                    makeGRangesFromDataFrame(mir_crosslinks_per_cond$IP_WT, keep.extra.columns = T))

# make a data frame from the ago bs
names(ago_bs)<- 1:NROW(ago_bs)
ago_bs <- as.data.frame(ago_bs)

# add mir info to ago bs
ago_bs_chi <- cbind(ago_bs[queryHits(idx),], mir_IP_WT = mir_crosslinks_per_cond$IP_WT[subjectHits(idx),]$Name)

ago_bs_chi <- ago_bs_chi %>% 
  mutate(., n_chimerics = length(mir_IP_WT), .by = c("seqnames", "start", "strand")) %>%
  tidyr::nest(mir_IP_WT) 

```

- AGO binding sites with a chimeric read: `r nrow(ago_bs_chi)` , `r nrow(ago_bs_chi) / nrow(ago_bs) ` 


## Enriched sharing of binding sites by two miRs

Ago binding sites can contain more than one miR. Here we look at which miR sharing is enriched.
The heatmap shows the r p-values of fisher-tests after bh adjustment.

```{r, fig.width= 20, fig.height=20}
# ----------------------------------------
# Coocruence of multiple miRs in same Ago2 BS
# Figure 1 e
# ----------------------------------------

# get co-occurences of top 10 mirs
t <- ago_bs_chi %>% mutate(n_different_mirs = map(data, ~length(unique(.x$mir_IP_WT))) %>% unlist(.),
                  c_mir181a = map(data, ~ "mmu-miR-181a-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir181b = map(data, ~ "mmu-miR-181b-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir142a = map(data, ~ "mmu-miR-142a-3p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir16 = map(data, ~ "mmu-miR-16-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir20a = map(data, ~ "mmu-miR-20a-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_let_7a = map(data, ~ "mmu-let-7a-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir17 = map(data, ~ "mmu-miR-17-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir181c = map(data, ~ "mmu-miR-181c-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir181d = map(data, ~ "mmu-miR-181d-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_let_7f = map(data, ~ "mmu-let-7f-5p" %in% .x$mir_IP_WT) %>% unlist(.),
                  c_mir93 = map(data, ~ "mmu-miR-93-5p" %in% .x$mir_IP_WT) %>% unlist(.)
                  )


# function for fisher test 
fisher_fun <- function(v){
  overlap_m <- eulerr::euler(data.frame(m[,v[[1]]], m[, v[[2]]] ))
  
  plot(overlap_m , quantities = TRUE, shape = "ellipse")
  
  
  v <- overlap_m$original.values
  v <- matrix(c(v[3], v[1], v[2], length(m[,1])), ncol = 2)
  
  f <- fisher.test(v)
  f$p.value
}

# make matix of top 10 miRs
m <- as.matrix(t[ ,grepl(colnames(t), pattern = "c_")])
# calc p-value and adj p-value from pairwise fisher tests
p.values <- combn(x = 1:ncol(m), m = 2, fisher_fun)
p.adj <- p.adjust(p.values)

# make plotable matirx
n <- ncol(m) 
mat <- `dimnames<-`(matrix(0,n,n), list(colnames(m), colnames(m)))
mat[lower.tri(mat, diag = F)] <- as.vector(p.adj)

mat <- t(mat) +mat
mat <- -log10(mat)

mat[mat==Inf] <- 200
mat[mat<log10(0.01)] <- 0

# plot with ComplexHeatmap
col_fun = colorRamp2(c(0, 20, 200), c("white",  "orange", "firebrick"))

lgd = list(grid_width = unit(2, "cm"), grid_height= unit(100, "cm"), labels_gp = gpar(fontsize = 30))

h <- Heatmap(mat, col = col_fun,
         row_names_gp = gpar(fontsize = 30),
        row_names_max_width = unit(10, "cm"),
         column_names_gp = gpar(fontsize = 30),
        column_names_max_height = unit(10, "cm"),
        heatmap_legend_param = lgd)
h

```

```{r cooccurence_heatmap}
pdf(file = paste0(out, "Figure1F_co-occurence_heatmap.pdf"), width = 11, height = 10)
h
dev.off()

```

## N different miRs per Ago BS

```{r}
# ----------------------------------------
# Number of different miRs in same Ago2 BS
# Supplementary Figure 1 g
# ----------------------------------------


t <- table(t$n_different_mirs) %>% as.data.frame()

t10 <- t %>% subset(., as.numeric(Var1) >= 10) 
t <- t %>% subset(as.numeric(Var1) <= 10) 
t[(as.numeric(t$Var1) == 10),]$Freq <- sum(t10$Freq)
t$Var1 <- as.numeric(t$Var1)

t <- rbind(c(0, nrow(ago_bs) - nrow(ago_bs_chi)), t)

sum(t[3:10,]$Freq)/ sum(t$Freq)

ggplot(t, aes(x = Var1, y = Freq))+
  geom_col()+
  xlab("Number of different miRs per Ago2 BS")+
  ylab("Number of Ago2 BS")

ggsave(paste0(out, "Distinct_mirs_per_Ago2_BS.pdf"), width = 5, height = 6, units = "cm")


```


# Comparison to mir181 quantification from imgen

Here we compare detected miR amounts to the publicity available quantification from Immgen.

```{r}
# ----------------------------------------
# Comparison of miR numbers to PCR abundace from immgen
# Figure 1 c
# ----------------------------------------

comp_df <- table(mir_crosslinks_per_cond$IP_WT$Name) %>% as.data.frame(.) %>%
  rowwise(.)%>%
  mutate(Var1 = substr(Var1, 5, nchar(as.character(Var1)))) 

mir_imgen <- mir_imgen %>% full_join(comp_df, by = c(ID_REF = "Var1"))

p4 <- ggplot(mir_imgen, aes(x = log10(mean), y = log10(Freq)))+
  geom_point(fill="#b4b4b4", colour="black", size=3, shape=21)+ #changed by nikita
  geom_point(data=mir_imgen[mir_imgen$ID_REF == "miR-181a-5p",],aes(x = log10(mean), y = log10(Freq)), fill="#8D0391", colour="black", size=4, shape=21)+ # changed by nikita
  geom_point(data=mir_imgen[mir_imgen$ID_REF == "miR-181b-5p",],aes(x = log10(mean), y = log10(Freq)), fill="#8D0391", colour="black", size=4, shape=21)+ # changed by nikita
  geom_text_repel(data=mir_imgen[mir_imgen$ID_REF %in% c("miR-181a-5p", "miR-181b-5p"),], aes(x = log10(mean), y = log10(Freq), label=ID_REF))+ #Nikita
  geom_smooth(method =lm,se=F, colour=farbe1)+
  stat_cor()+
  xlab("Mean Abundance Imgen")+
  ylab("Abundance chimeric miRs in miR-eCLIP")

p4

p4 <- p4 + theme_paper()

ggsave(p4, filename = paste0(out, "Figure1c_Comparison_miR_expression_Imgen_nv.pdf"), width = unit(6, "cm"), height = unit(6,"cm"))

```

# Save files
```{r}
saveRDS(mir_crosslinks_per_cond, file = paste0(out, "mir_chimeric_crosslinks.rds"))

```

# Session Info

```{r}

sessionInfo()
```



